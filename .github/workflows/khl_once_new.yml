name: khl_once_new

on:
  workflow_dispatch: {}

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      UID: "897694"          # UID матча
      SEASON: "1369"         # сезон
      OUT_DIR: "public/khl/json"

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt

      - name: Fetch PDF via curl → parse → write JSON
        run: |
          set -e
          mkdir -p "$OUT_DIR"
          PDF_URL="https://khl.ru/pdf/${{ env.SEASON }}/${{ env.UID }}/game-${{ env.UID }}-start-ru.pdf"
          UA="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"

          curl -sSL --http2 --fail \
            -H "Accept: application/pdf,application/octet-stream;q=0.9,*/*;q=0.8" \
            -H "Accept-Language: ru,en;q=0.9" \
            -H "Referer: https://khl.ru/" \
            -H "User-Agent: $UA" \
            -o /tmp/game.pdf "$PDF_URL"

          python - <<'PY'
          import re, pathlib, fitz, os, unicodedata, json

UID = int(os.environ["UID"])
OUT_DIR = os.environ["OUT_DIR"]

def norm(s:str)->str:
    s = unicodedata.normalize("NFKC", s)
    s = s.replace("\xa0"," ").replace("\u2009"," ").replace("\u202f"," ")
    return re.sub(r"[ \t]+"," ", s)

# 1) читаем PDF
pdf_bytes = pathlib.Path("/tmp/game.pdf").read_bytes()
doc = fitz.open(stream=pdf_bytes, filetype="pdf")

texts=[]
for i, p in enumerate(doc):
    t = p.get_text("text")
    print(f"\n===== PAGE {i+1} :: get_text('text') =====\n{t}\n")
    texts.append(t)
doc.close()

full = norm("\n".join(texts))
lines = [norm(x).strip() for x in full.splitlines() if x.strip()]

# 2) кладём диагностические файлы в Pages
raw_dir = pathlib.Path(OUT_DIR).parent / "raw"   # public/khl/raw
raw_dir.mkdir(parents=True, exist_ok=True)
(pathlib.Path(raw_dir)/f"{UID}_full.txt").write_text(full, encoding="utf-8")
(pathlib.Path(raw_dir)/f"{UID}_tail150.txt").write_text("\n".join(lines[-150:]), encoding="utf-8")

# 3) временный JSON, чтобы прошёл деплой
out = {
  "ok": True,
  "uid": UID,
  "data": {"teams":[None,None],"date":None,"time_msk":None,
           "main_referees":[],"linesmen":[],"goalies":{"home":[],"away":[]}},
  "debug": {"tail_url": f"khl/raw/{UID}_tail150.txt", "full_url": f"khl/raw/{UID}_full.txt"}
}
pathlib.Path(OUT_DIR).mkdir(parents=True, exist_ok=True)
(pathlib.Path(OUT_DIR)/f"{UID}.json").write_text(json.dumps(out, ensure_ascii=False, indent=2), encoding="utf-8")

print("\n===== HEAD 60 =====")
for i,l in enumerate(lines[:60],1): print(f"{i:03d}: {l}")
print("\n===== TAIL 120 =====")
for i,l in enumerate(lines[-120:], len(lines)-120+1): print(f"{i:03d}: {l}")


          PY

      - uses: actions/upload-pages-artifact@v3
        with: { path: ./public }

      - uses: actions/deploy-pages@v4
